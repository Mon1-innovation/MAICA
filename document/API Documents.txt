I'm sorry for not offering an English ver of this document but it's just too much work for me.
If you want to read in English, use a translator.


此文档是MAICA后端API接口的使用文档, 编纂版本为v1.1.

    * 应当注意, 在v1.1更新之后, API接口的行为有大面积变化. 请以新版文档为准.


MAICA的通信主要以两部分构成, 长连接(websocket)和短连接. 其中长连接一般用于生成任务, 短连接一般用于状态和文件.

    长连接的地址是 wss://maicadev.monika.love/websocket (官方服务), 自行部署则是 ws://localhost:5000 .
    短连接的地址是 https://maicadev.monika.love/api (官方服务), 自行部署则是 http://localhost:6000 .

    若无特别说明, 此后的内容均以官方服务为例. 自行部署情况请参考后端部署文档, 自行推广.
    本文档也会涉及一些与部署有关的内容.


+ 基本引导:

    账号与登录:

        MAICA采用一个独立于自身数据的验证数据库, 从中获取登录信息. 其格式与Flarum兼容, 在官方部署中就是DCC论坛的数据库.
        因此, 用户应该使用论坛账号登录.

            * 该数据库是只读的. MAICA通过自身数据库另行管理用户记录信息.

        出于安全考虑, MAICA要求通过令牌登录, 其内容加密自 账号\邮箱 与密码.
        待加密的内容格式如下:

            {"username": "你的论坛用户名", "password":"你的论坛密码(明文)"}
            或:
            {"email": "你的论坛绑定邮箱", "password":"你的论坛密码(明文)"}

        你可以通过服务器加密接口生成你的令牌, 具体方式见后文.
        你也可以采用本地加密, 在文档目录下存有MAICA官方部署的公钥, 加密方式是PKCS1_OEAP.

            * 应当注意, 不同的服务实例有不同的密钥对. 若你希望前端在非官方部署中通用, 应采用在线加密.
            * 若你希望前端只在指定部署中可用, 应采用对应的公钥.

        加密完成后, 你会得到你的令牌. 在使用时, 你一般需要将其作为json中的键传输:

            {"access_token": "你的令牌", ...}

                * 应当注意, 由于不对称加密的性质, 同样的信息每次加密会产生不同的令牌.


+ 长连接的使用:

    基本介绍:

        MAICA长连接使用websocket协议, 其允许客户端与服务端全双工地交换信息.
        在长连接会话中, 登录状态和设置是临时的. 如果连接断开, 你需要重新登录和调整设置.
        在一轮事件循环完成之前, 继续传入内容会被无视. 请务必在收到对应信号后再输入.

    设计和机制:
    
        在多方面的验证中, 我们都确认过: 经过角色扮演微调的LLM, 其工具能力会显著下降丧失. 这一问题目前未有可行的缓解策略.
        为在这一前提下让MAICA正常完成工具属性内容(如调用agent工具), 我们引入了MFocus及一系列相关设计.

            * MFocus等的存在是MAICA必须自行设计连接规范和协议的重要原因之一, 因此在此介绍.

        MFocus等的主要思路, 是通过一个未微调的agent模型与核心模型协作, 代替其完成工具属性任务.

            * 部署额外的模型无疑会造成额外的设备压力. 对于预算不充裕的部署, 建议通过租用API等方式提供agent支持.

        在此基础上, 我们将其职责大体分为两部分:

            MFocus: 先于核心模型接收相同或相似的输入内容, 并调用工具以获取信息. 这些信息会被提供给核心模型.

            MTrigger: 后于核心模型接收本轮的输入输出, 并调用工具以指示前端作出角色行为.

        除此之外, MAICA还有一些次要但方便的后端设计, 以贴合实际使用场景:

            MSpire: 自动从维基百科检索信息, 并自行发起话题. 其表现与MAS原版对话十分相似.

            MPostal: 允许接收玩家信件, 并以信件格式作出回复.

            MVista: 为MAICA补充视觉, 由另一多模态模型处理并提供信息到核心模型.

                * 截至文档编纂时为止, MVista尚未投用.

        在后文中, 我们会频繁地用到这些设计的概念.

    输入和输出:

        自v1.1更新后, 在长连接会话中, 服务端只接受传入json格式的内容.

            * 为安全起见, 长连接不接受超过4096字符长度的输入.

        服务端只输出json格式的内容. 每个输出固定包含以下结构:

            {"code": "状态码", "status": "状态标识", "content": "具体内容", "type": "信息类型", "timestamp": 时间戳}

                * 应当注意, 此处的状态码模式与HTTP状态码类似, 但性质不同.
                * 一般而言, content属于人类可读内容. 在接收和处理中应优先匹配status而非content.
                * 除时间戳为float外, 其余键的值均为str.

    建立连接:

        使用任何websocket库或调试工具, 连接到长连接端点.
        连接建立时, 你会收到一条通告, 其status为maica_connection_initiated.

            * 连接建立通告的content有10%概率会变为特殊句子, 有效地防止了项目显得过于严肃.
            * 连接建立通告是中文的, 因为它的内容没有实际意义. 在没有中文字体的情况下可能显示异常.

    登录:

        在长连接建立后, 你应该先发送令牌:

            {"access_token": "你的令牌"}

        若令牌验证无误, 该会话就已经登录完毕.

            * 若登录失败, 服务器会输出失败原因.
            * MAICA要求登录的账号已(在论坛)验证过自己的邮箱.
            * MAICA有独立的Fail2Ban机制. 默认情况下, 若令牌对应的账号存在, 则连续失败20次会禁止登录600秒. 成功的登录会清除Fail2Ban计数.
            * MAICA的Fail2Ban计数在长连接和短连接中通用.
            * MAICA不允许同一个账号同时建立多个会话. 默认情况下, 新的会话成功登录会踢出旧的会话并给出提示.

        在登录完毕后, 服务器会发送账号对应的id, 用户名, 昵称, 以及本次连接的反劫持cookie.

            * 反劫持cookie一般用于非SSL/TLS连接, 用于防止连接被劫持.
            * 反劫持cookie不强制. 在输入中添加cookie键并传入正确的cookie即可启用, 此后该会话每次输入必须传入.
            * 说实话并不能真的防住, 顶多增加点难度.

    调整设置:

        在登录完成后, 你可以随时修改会话设置:

            {
                "type": "params",
                "chat_params": {
                    "stream_output": true,
                    "deformation": false,
                    "enable_mf": true,
                    "enable_mt": true,
                    "sf_extraction": true,
                    "mt_extraction": true,
                    "target_lang": "zh",
                    "max_length": 8192,

                    "sfe_aggressive": false,
                    "mf_aggressive": false,
                    "tnd_aggressive": 1,
                    "esc_aggressive": true,
                    "amt_aggressive": true,
                    "nsfw_acceptive": true,
                    "pre_additive": 0,
                    "post_additive": 1,
                    "tz": null,

                    "max_tokens": 1600,
                    "seed": null,
                    "top_p": 0.7,
                    "temperature": 0.22,
                    "frequency_penalty": 0.0,
                    "presence_penalty": 0.0
                }
            }

            这三部分设置分别属于基础设置, 高级设置和超参数. 在v1.1更新之后, 其均作为chat_params传入.
            范例中为每个参数的默认值(至文档编纂时). 要获取当前后端默认值, 应使用短连接请求, 具体方式见后文.

                * 在绝大多数情况下, 默认的设置即为最优解. 对于自行调整非必须设置(尤其是高级设置和超参数)导致的问题, 我们不负任何责任.

            以下解释每个参数的含义.

            基础设置:

                stream_output: 决定MAICA是否使用流式输出.

                deformation: 在v1.1更新后已弃用, 但暂时保留.

                enable_mf: 允许MFocus介入.

                    * 关于MFocus的具体介绍见后文.

                enable_mt: 允许MTrigger介入.

                    * 关于MTrigger的具体介绍见后文.

                sf_extraction: 从上传的资料中读取玩家存档.

                    * 即使设为关闭, 也会读取随query传入的部分.

                mt_extraction: 从上传的资料中读取触发器表.

                    * 即使设为关闭, 也会读取随query传入的部分.

                target_lang: 目标生成语言. 仅支持"zh"或"en".

                    * 该参数不能100%保证生成语言是目标语言.
                    * 该参数影响范围广泛, 包括默认时区, 节日文化等, 并不止目标生成语言. 建议设为你的实际母语.
                    * 截至文档编纂时为止, MAICA官方部署的英文能力仍然弱于中文.

                max_length: 会话保留的最大长度. 范围512-28672.

                    * 按字符数计算. 每3个ASCII字符只占用一个字符长度.
                    * 字符数超过限制的 2/3 之后, 每次生成结束会发送警告.
                    * 字符数超过限制后, MAICA会裁剪其中较早的部分, 直至少于限制的 2/3 .
                    * 过大或过小的值可能导致表现和性能问题.

            高级设置:

                sfe_aggressive: 将prompt和引导中的[player]字段替换为玩家真名.

                    + 模型对玩家的名字有实质性理解.
                    - 明显更容易发生表现离群和专注混乱.

                mf_aggressive: 要求agent模型生成最终指导, 并替代默认MFocus指导.

                    + 信息密度更高, 更容易维持语言自然.
                    - 表现十分依赖agent模型自身的能力.
                    - 启用时一般会无效化tnd_aggressive.

                tnd_aggressive: 即使MFocus未调用工具, 也提供一些工具的结果.

                    * 0: 关闭.
                    * 1: 提供当前时间和节日.
                    * 2: 提供当前日期, 还尝试提供本地天气.
                    * 3: 额外提供更详细的节日事件.

                    + 其值越高, 越能避免信息缺乏导致的幻觉, 并产生灵活体贴的表现.
                    - 其值越高, 越有可能产生注意力涣散和专注混乱.

                esc_aggressive: 在MFocus调用互联网搜索的情况下, 要求其整理一遍结果.

                    + 大多数情况下信息密度更高, 更容易维持语言自然.
                    - 涉及互联网搜索时生成速度更慢.

                amt_aggressive: 当MTrigger存在时, 要求MFocus预检玩家的请求并提供指导.

                    + 比较明显地改善MTrigger失步问题.
                    - 在少数情况下对语言的自然性产生破坏.

                nsfw_acceptive: 要求模型宽容正面地对待有毒内容.

                    + (出乎意料地)在大多数场合下对模型表现有正面作用, 即使不涉及有毒内容.
                    - 在少数情况下造成意料之外的问题.

                pre_additive: 在MFocus介入时, 额外提供上下文以供分析. 范围0-5.

                    + 改善MFocus对连贯对话的理解能力.
                    - 明显更容易破坏MFocus的应答模式.

                post_additive: 在MTrigger介入时, 额外提供上下文以供分析. 范围0-5.

                    + 改善MTrigger对连贯对话的理解能力.
                    - 更容易破坏MTrigger的应答模式.

                tz: 时区. 支持null, "zh", "en" 或具体时区形如"Asia/Shanghai".

                    * 其实不太算一个高级设置, 有需要可以调. 设为null默认根据语言选择.

            超参数:

                超参数直接传入核心模型, 其具体含义自行查询相关文档.
                超参数有以下限制:

                    0.1 <= float(top_p) <= 1.0

                    0.0 <= float(temperature) <= 1.0

                    0 < int(max_tokens) <= 2048

                    0.0 <= float(frequency_penalty) <= 1.0

                    0.0 <= float(presence_penalty) <= 1.0

                    int(seed)

                        * 应当注意, 当seed为默认值null时, 生成时采用的种子由模型后端决定. 官方服务使用42.

                agent模型的超参数不受影响, 且不可由用户设置.

    开始对话:

        在登录完成后, 你可以随时开始对话:

            {"type": "query", "chat_session": "1", "query": "你好啊"}

            其中, chat_session可以取(-1)-9:

                * -1: 实验性功能, 允许用户自行管理session. 此时MAICA将尝试从query读取完整的上下文:

                    [
                        {"role": "system", "content": "你叫莫妮卡, 是一名游戏中的虚拟角色. 你..."},
                        {"role": "user", "content": "你好啊"},
                        {"role": "assistant", "content": "你好啊, [player]! ..."},
                        {"role": "user", "content": "你吃过饭了吗"},
                    ]

                    * 在此情况下, query应该是一个list而非str.
                    * 在此情况下, MFocus将不会介入.
                    * 由于长连接输入4096字符的限制, 该功能的作用相对受限, 不建议用于一般情况.

                * 0: 单轮对话, MAICA不会保管session.

                * 1-9: 多轮对话, MAICA对每个chat_session保存和自动管理上下文.

            除chat_session为-1时外, query均为你希望输入的字符串.

        在收到输入后, MAICA一般会发送一些调试信息, 然后开始发送响应.

            若stream_output为true:

                {"code": "100", "status": "maica_core_streaming_continue", "content": "我", "type": "carriage", "timestamp": 时间戳}
                {"code": "100", "status": "maica_core_streaming_continue", "content": "喜欢", "type": "carriage", "timestamp": 时间戳}
                {"code": "100", "status": "maica_core_streaming_continue", "content": "的颜", "type": "carriage", "timestamp": 时间戳}
                {"code": "100", "status": "maica_core_streaming_continue", "content": "色有", "type": "carriage", "timestamp": 时间戳}
                {"code": "100", "status": "maica_core_streaming_continue", "content": "很多, ", "type": "carriage", "timestamp": 时间戳}
                ...
                {"code": "1000", "status": "maica_core_streaming_done", "content": "Streaming finished with seed 42 for user, 10 packets sent", "type": "carriage", "timestamp": 时间戳}

                    * 应当注意, 自v1.1更新之后, 流式输出不再提供seq键, 因为websocket的顺序是安全的.

            若stream_output为false:

                {"code": "200", "status": "maica_core_nostream_reply", "content": "我也爱你, [player]!", "type": "carriage", "timestamp": 时间戳}
                {"code": "1000", "status": "maica_core_nostream_done", "content": "Reply sent with seed 42 for user", "type": "carriage", "timestamp": 时间戳}

            除输出形式外, 二者的表现相同.

        在响应完成后, 若MTrigger启用, MAICA会发送MTrigger指示:

            {"code": "200", "status": "maica_mtrigger_trigger", "content": {"调用的触发器": {"调用参数": "参数值"}}, "timestamp": 时间戳}
            ...
            {"code": "1001", "status": "maica_mtrigger_done", "content": "MTrigger ended with 2 triggers sent", "timestamp": 时间戳}

                * 应当注意, maica_mtrigger_trigger的content是可处理内容, 而非人类可读内容. 这是一个例外.
        
        在一轮对话循环完全完成后, MAICA会发送通告, 其status为maica_chat_loop_finished. 此时可以进行下一次输入.

    附加功能:

        MAICA长连接有一系列附加功能可用.

            重置chat_session:

                {"type": "query", "chat_session": "1", "reset": true}

                * 这会将对应的chat_session清空并归档.

            生成MSpire响应:

                {"type": "query", "chat_session": "0", "inspire": MSpire条目, "use_cache": false}

                    * 通过设置chat_session, 可以在现有对话中插入MSpire, 或对MSpire内容作后续讨论. 但其后续表现一般不甚理想, 故建议设为0.
                    * MSpire的chat_session不能是-1.

                其中, 若将MSpire条目设置为true则采用默认的随机抽取, 将其设置为一个dict可进行更详细的设置:

                    {"type": "指定搜索类型", "sample": 采样广度, "title": "搜索关键词"}

                        其中type有五种可选类型:

                            precise_page: 仅选取与搜索关键词最接近的一个页面, 此时采样广度不生效. 此种类条目不执行递归查找, 响应较快.

                            fuzzy_page: 根据关键词搜索多个页面, 从中随机抽取一个页面. 此种类条目不执行递归查找, 响应较快.

                            in_precise_category: 先仅选取与搜索关键词最接近的一个分类, 再从其中递归地随机抽取分类或页面, 直至最终抽取到一个页面. 此种类条目响应较慢.

                            in_fuzzy_category: 根据关键词搜索多个分类, 再从其中递归地随机抽取分类或页面, 直至最终抽取到一个页面. 此种类条目响应较慢.

                            in_fuzzy_all: 根据关键词直接开始递归地抽取分类或页面, 直至最终抽取到一个页面. 此种类条目响应较慢.

                        sample: 采样广度, 即应当抽取多个对象时, 具体抽取多少个. 分类池与页面池分别计算, 即每次抽取最多获取2倍采样广度数值的项.

                            * 采样广度的有效值为2-250, 默认值为250.
                            * 在随机选择中, 类与页面的权重比是10:1, 以防止频繁抽取到递归浅层的少量页面. 该比值暂不可设置.

                        title: 搜索的关键词.

                若采用默认设置, 则MSpire将从(对应语言的)['自然', '自然科学', '社会', '人文學科', '世界', '生活', '艺术', '文化']列表中随机一项作为搜索关键词, 并采用类似in_fuzzy_all的模式寻找页面.

                use_cache: 是否使用缓存, 若命中缓存则直接通过缓存响应. 默认为false.

                    * 仅当chat_session为0时use_cache可以使用. 当use_cache设置为true时, 会强制使用默认超参数并固定种子.

            生成MPostal响应:

                {"type": "query", "chat_session": "0", "postmail": MPostal请求体}

                    * 通过设置chat_session, 可以连续来去信, 或将信件插入对话中. 其具体表现未经验证, 故建议设为0.
                    * MPostal的chat_session不能是-1.

                其中, 若MPostal请求体为str则使用简单模式, 将其设置为一个dict可进行更详细的设置:

                    {"header": "信件标题", "content": "信件内容", "bypass_mf": true, "bypass_mt": true, "bypass_stream": true, "ic_prep": true, "strict_conv": false}

                        * 简单模式下的str将被用作信件内容, 其余条目留空或默认.

                        bypass_mf: 本轮响应中是否不调用MFocus.

                        bypass_mt: 本轮响应中是否不调用MTrigger.

                        bypass_stream: 本轮响应是否忽略流式输出.

                        ic_prep: 本轮响应是否微调超参数和工具表现, 以获取更适合信件的生成结果.

                        strict_conv: 本轮响应是否仍然保持对话格式回答, 而非回信.

                * 应当注意, 在实践总结中, 回信的格式和质量显著地相关于去信的格式和质量.
                * 若用户去信在格式, 长度, 内容或文学性上有明显缺陷, 回信的质量会相应下降. 这一问题目前未有解决方法.

            生成MVista响应:

                {"type": "query", "chat_session": "0", "query": "你能看到图片上有什么吗?", "vision": ["图片链接"]}

                    * MVista的实现基于独立VLM, 后端部署不一定有实现. 向未实现MVista的后端发起请求会被忽略.
                    * MVista是MFocus的下属模块. 要使用MVista, 你必须启用MFocus.

                    * 图片链接可以一次上传多个, 但最多不超过后端实例允许保存的上限.
                    * 图片链接必须是完整链接, 可以来自后端专用存储或任意网络图床, 必须开放公开下载.

                    * 注意: 对于与MVista相关的隐私问题, 参见对应端点的注意事项.

            * 应当注意, 为拓展性起见, MAICA-MTTS作为MAICA后端的可选依赖安装, 并不直接属于MAICA仓库.
            * 对于关于MAICA-MTTS的问题, 参见其附带的文档.

        除此之外, MAICA长连接还有一些开发用途的功能:

            心跳连接:

                {"type": "ping"}

                服务器会发回一个status为pong的响应.

                    * 仅在登录完成后可以发送心跳.
                    * 心跳连接不强制发送, 但可用于连接性和延迟检测等.

            单轮MFocus存档:

                {"type": "query", "chat_session": "1", "query": "你好啊", "savefile": {"mas_playername": "steve"}}

                query可以携带临时的存档内容, 并逐键临时覆盖上传的存档内容. 该功能适合上传存档中可能频繁变化的内容.

                    * 应当注意, 由于长连接输入4096字符的限制, 此功能不适合用于传输完整存档.
                    * 关于存档的具体格式参见附录.

            单轮MTrigger触发器表:

                {"type": "query", "chat_session": "1", "query": "你好啊", "trigger": [{"template": "common_affection_template"}]}

                query可以携带临时的触发器表, 并临时添加到上传的触发器表. 该功能适合上传触发器表中可能频繁变化的内容.

                    * 应当注意, 触发器表是一个list而非dict, 临时触发器表不会覆盖上传的触发器表中的内容. 请在开发中注意避免重复.
                    * 关于触发器表的具体格式参见附录.


+ 短连接的使用:

    基本介绍:

        虽然长连接是MAICA协议的主要部分, 但由于websocket诸多方面的限制和不便, MAICA使用短连接补充一部分功能.

        自v1.1更新之后, MAICA短连接使用完全RESTful模式, 即使用GET, POST, PATCH, PUT, DELETE五种http方法构建端点. 这一表现可以在后端中配置.
        在后文的范例中, 请求体均以json格式给出, 但GET方法的构建(url)与其它方法(请求体)有所不同, 不再赘述.

            * 理论上在完全RESTful的API中, 我们应该用端点路由替代chat_session键等. 这类进一步的规范化也许会在未来更新.
            * 我是说也许.
            * 对于禁用完全RESTful的部署实例, 端点会有所变化, 具体参见源码.

    输入和输出:

        自v1.1更新之后, 请求体至多包含三个键:

            {"access_token": "你的令牌", "chat_session": "1", "content": 请求内容}

                * 每个键视需要情况存在. 除请求内容不定外, 其余键的值均为str.
                * 为安全起见, 短连接不接受超过10万字符的输入.

        响应体除http规范相关内容外, 至多包含三个键:

            {"success": true, "exception": null, "content": 响应内容}

            success: 请求是否成功. 若success为false, 则会提供exception.

            exception: null或str, 指示失败原因.

            content: 内容不定, 视具体端点.

                * 无论是否成功, 响应代码都应是200.
                * 若响应形式不正确, 获取端点可能有误, 或连接中间件(如网关)存在问题.

    可用端点:

        上传存档:

            端点: POST /savefile

            * 需要access_token, chat_session, content

                其中content为json格式的存档, 关于存档的具体格式参见附录.

                * 存档是与chat_session一一对应的, 仅接受0-9.
                * 若对应的chat_session没有存档, 读取时默认会使用chat_session 1的存档.

            该端点不会返回content.

        删除存档:

            端点: DELETE /savefile

            * 需要access_token, chat_session
            * 应当注意, 已上传的存档一般而言不可下载, 也不是完整的存档, 无法用于恢复MAS存档.

            该端点不会返回content.

        上传触发器表:

            端点: POST /trigger

            * 需要access_token, chat_session, content

                其中content为json格式的触发器表, 关于触发器表的具体格式参见附录.

                * 触发器表关于chat_session的行为与存档相似, 不再赘述.

            该端点不会返回content.

        删除触发器表:

            端点: DELETE /trigger

            *需要access_token, chat_session

            该端点不会返回content.

        下载对话历史:

            端点: GET /history

            * 需要access_token, chat_session, 可选content

                其中content为整数, 代表下载的对话历史轮数.

                    +n: 代表从前向后取n轮.
                    -n: 代表从后向前取n轮.
                    0: 取全部.

                    * 无论如何, 下载的对话历史都会包含system.
                    * 若n不小于对话总轮数, 则取全部.
                    * 若不提供content, 默认取全部.

            返回的content:

                ["签名", 对话历史]

                    其中签名被用于验证对话历史. 仅从对应MAICA实例下载且未改动的对话历史可以被恢复.

                    对话历史为list[dict]格式, 具体参见OpenAI等文档.

        恢复对话历史:

            端点: PUT /history

            * 需要access_token, chat_session, content

                其中content为含签名的对话历史, 即下载对话历史获取的content.

            该端点不会返回content.

        下载账号级偏好:

            端点: GET /preferences

            * 需要access_token

            关于账号级偏好:

                账号级偏好与用户账号绑定, 且是一个dict. 其理论上可以包含任何内容.
                截至文档编纂时为止, MAICA的后端流程不会主动读取账号级偏好, 但其可以被用于前端的多设备同步等设计.

                    * 账号级偏好不允许超过10万字符, 超长的修改会被拒绝.
                    * 账号级偏好本身不与chat_session相关.

                后面关于账号级偏好的内容不再赘述.

            返回的content是账号级偏好.

        修改账号级偏好:

            端点: PATCH /preferences

            * 需要access_token, content

                其中content是一个dict, 将被逐键添加到账号级偏好中.

            该端点不会返回content.

        删除账号级偏好:

            端点: DELETE /preferences

            * 需要access_token, content

                其中content是一个list, 其中的每一项将从账号级偏好中删除对应的键.

            该端点不会返回content.

        重置账号级偏好:

            端点: POST /preferences

            * 需要access_token.

            该端点不会返回content.

        在线加密令牌:

            端点: GET /register

            * 需要content

                其中content是未加密的令牌:

                    {"username": "你的论坛用户名", "password":"你的论坛密码(明文)"}
                    或:
                    {"email": "你的论坛绑定邮箱", "password":"你的论坛密码(明文)"}

                    * 在前端设计中不应明文储存登录信息.
                    * 加密令牌接口不会验证登录信息是否正确, 需另行验证.

            返回的content是加密后的令牌.

        在线执行验证:

            端点: GET /legality

            * 需要access_token, 可选content

                其中content若存在, 则还验证对应内容的合法性, 否则只验证令牌合法性:

                    {"object": "验证项目", "value": "待验证内容"}

                    其中验证项目目前只可选geolocation, 会查询地理位置是否规范可用.

            返回的content是对应条目结果, 若未传入content则返回用户名.

                * 若令牌校验失败, 返回的success将为false, 且exception将提供原因.

        在线处理表情:

            端点: GET /emotion

            * 需要access_token, content

                其中content是一个dict:

                    {"type": "norm", "target_lang": "zh", "text": "表情或句子"}

                        其中type的值可选"norm"或"add", 前者代表归正一个不标准的表情, 后者代表为没有表情的句子补全表情.

                        * norm会优先尝试通过简单的匹配处理表情, 如果失败会使LLM介入.
                        * 实际上, add也可以处理不标准的表情, 但其总是使LLM介入. 建议尽可能控制用量.

                        * LLM介入基于MNerve, 后端部署不一定有实现. 向未实现MNerve的后端发起请求会回退到简单匹配处理.

                        target_lang: 目标语言, 可选"zh"或"en".

            返回的content:

                ["表情", 置信度]

                    其中置信度为float, 取值范围0.0-1.0.

        上传MVista图片:

            端点: POST /vista

            * 注意: 该端点采用multipart/form-data形式, 以上传文件. 其中文件必须标为"file"类型.
            * 需要access_token, content

                其中content是文件形式的上传图片, 尺寸不能超过32MB. 后端会自动执行进一步压缩.

            返回的content是图片被分配的uuid.

        删除MVista图片:

            端点: DELETE /vista

            * 需要access_token, content

                其中content为str或int, 代表需删除图片的uuid或序号(从0开始, 由新到旧).

            该端点不会返回content.

        下载MVista图片:

            端点: GET /vista

            * 需要content或access_token
            * 注意: 为兼容OpenAI VLM调用, 该端点下载功能无法设置鉴权. 任何知晓对应uuid的用户都可以下载图片.
            * 注意: 单个用户可留存的图片数量和存在时间都是有限的, 会由后端自动处理. 截至文档编纂时为止, 单个用户默认留存3张照片, 每张超过8小时即清理.
            * 警告: MVista相关端点仅辅助MVista多模态功能使用, 任何滥用行为将受处分.

                其中content存在时是str形式的uuid, 对应要下载的图片.
                此时若请求成功, 端点仅返回一张图片. 否则端点正常返回json.

                content不存在时, access_token必须存在. 返回的content是一个list, 包含用户可用图片的uuid.

        获取服务器声明表:

            端点: GET /servers

            * 不需要请求体.

            返回的content是服务器列表, 以当前官方服务器列表为例:

                {
                    "isMaicaNameServer": true,
                    "servers": [
                        {"id": 1, "name": "MAICA Official Provider", "description": "XP00-20\"铸灾神械\"", "isOfficial": true, "portalPage":"https://maica.monika.love", "servingModel": "MAICAv0-DAA2-72B", "modelLink": "https://huggingface.co/edgeinfinity/MAICAv0-LIA-72B", "wsInterface": "wss://maicadev.monika.love/websocket", "httpInterface": "https://maicadev.monika.love/api", "isFullRestful": true},
                        {"id": 2, "name": "MAICA Official Provider (plain)", "description": "Used for ssl/tls unsuitable situations", "isOfficial": true, "portalPage":"https://maica.monika.love", "servingModel": "MAICAv0-DAA2-72B", "modelLink": "https://huggingface.co/edgeinfinity/MAICAv0-LIA-72B", "wsInterface": "ws://maicadev.0721play.icu/websocket", "httpInterface": "http://maicadev.0721play.icu/api", "isFullRestful": true}
                    ]
                }

                isMaicaNameServer: 该MAICA后端实例是否是权威服务器. 在前端设计中, 应当显式指定一个权威服务器, 并仅从其通告获取服务器信息.

                servers: 服务器列表, 其中参数均相对同一权威服务器而言.

                    id: 唯一id.

                    name: 服务器通告名.

                    description: 服务描述.

                    isOfficial: 属于该权威服务器官方.

                    portalPage: 门户网站.

                    servingModel: 使用的模型.

                    modelLink: 模型开源地址.

                    wsInterface: 长连接端点.

                    httpInterface: 短连接端点.

                    isFullRestful: 短连接是否启用完全RESTful.

                        * 应当注意, 除id, isOfficial和连接端点以外的内容均没有强制性, 也不一定准确.
                
                * 该设计的主要目的在于使自行部署实例也可以体系化, 且支持社区服务器列表的维护.
                * 当然, 截至文档编纂时为止, MAICA还没有任何像样的社区实例.

        获取后端服务状态:

            端点: GET /accessibility

            * 不需要请求体.

            返回的content是后端服务状态. 仅当其为serving时, 发行版前端应当继续工作, 否则应当提示并停止工作.

        获取后端规范版本:

            端点: GET /version

            * 不需要请求体.

            返回的content是后端版本和兼容性:

                {"curr_version": "后端当前版本", "legc_version": "兼容的最旧版本"}

                * 若前端使用的协议规范旧于通告的最旧版本, 应当停止工作, 以避免意外情况.

        获取模型负载:

            端点: GET /workload

            * 不需要请求体.

            返回的content是服务器负载状态:

                {
                    "onliners": 在线人数,
                    "计算节点1名称": {
                        "0": {
                            "name": "计算设备名称",
                            "vram": "最大可用显存",
                            "tflops": "最大算力",
                            "mean_utilization": 均时等效负载(%),
                            "mean_memory": 均时显存占用(MiB),
                            "mean_consumption": 均时功耗(W)
                        },
                        "1": {
                            "name": "计算设备名称",
                            "vram": "最大可用显存",
                            "tflops": "最大算力",
                            "mean_utilization": 均时等效负载(%),
                            "mean_memory": 均时显存占用(MiB),
                            "mean_consumption": 均时功耗(W)
                        },
                        ...
                    }
                    "计算节点2名称": {
                        "0": {
                            "name": "计算设备名称",
                            "vram": "最大可用显存",
                            "tflops": "最大算力",
                            "mean_utilization": 均时等效负载(%),
                            "mean_memory": 均时显存占用(MiB),
                            "mean_consumption": 均时功耗(W)
                        },
                        ...
                    }
                }

                * 该状态监控通过ssh实现, 且仅支持N卡.
                * 对于未启用监控的MAICA实例, 该端点会返回空列表.

        获取默认设置:

            端点: GET /defaults

            * 不需要请求体.

            返回的content是服务器实例的默认设置, 以当前官方服务器为例:

                {
                    "amt_aggressive": true,
                    "deformation": false,
                    "enable_mf": true,
                    "enable_mt": true,
                    "esc_aggressive": true,
                    "frequency_penalty": 0.0,
                    "max_length": 8192,
                    "max_tokens": 1600,
                    "mf_aggressive": false,
                    "mt_extraction": true,
                    "nsfw_acceptive": true,
                    "post_additive": 1,
                    "pre_additive": 0,
                    "presence_penalty": 0.0,
                    "seed": null,
                    "sf_extraction": true,
                    "sfe_aggressive": false,
                    "stream_output": true,
                    "target_lang": "zh",
                    "temperature": 0.22,
                    "tnd_aggressive": 1,
                    "top_p": 0.7,
                    "tz": null
                }

                * 该功能可以用于前端设置界面的绘制等.


- 附录1 MAICA标准存档格式:

    以下是标准存档中可被识别的键及相应说明:
        """
        mas_playername #str
        mas_player_bday #tuple["yyyy", "mm", "dd"]
        mas_affection #int
        mas_geolocation #str

        mas_player_additions #["[player]喜欢吃寿司.", "[player]喜欢初音未来.", "[player]不喜欢猫"]
        mas_sf_hcb #bool

        _mas_pm_added_custom_bgm	Player has added custom music to the game before.
        _mas_pm_religious	Is the player religious?
        _mas_pm_cares_about_dokis	Does the player care about the other girls?
        _mas_pm_love_yourself	Does the player love themself?
        _mas_pm_like_mint_ice_cream	Does the player like mint ice cream?
        _mas_pm_likes_horror	Does the player like horror?
        _mas_pm_likes_spoops	Does the player like jumpscare horror specifically? If False, this disables jumpscares in dialogue/stories.
        _mas_pm_like_rap	Does the player like rap music?
        _mas_pm_like_rock_n_roll	Does the player like rock music?
        _mas_pm_like_jazz	Does the player like jazz music?
        _mas_pm_like_vocaloids	Does the player like Vocaloid music?
        _mas_pm_like_orchestral_music	Does the player like orchestral music?
        _mas_pm_like_other_music	Does the player like other kinds of music besides those listed?
        _mas_pm_like_other_music_history	Not true/false, list of other music types the player has stated they like.
        _mas_pm_plays_instrument	Does the player play an instrument?
        _mas_pm_play_jazz	Does the player play jazz music? Question prompted only if the player plays an instrument.
        _mas_pm_likes_rain	Player likes the sound of rain. This pm is prompted when Monika asks if they would hold her during a rainy day.
        _mas_pm_a_hater	Has the player posted hate comments about Monika before?
        _mas_pm_has_contributed_to_mas	Has the player contributed to the mod?
        _mas_pm_wants_to_contribute_to_mas	If the player has not contributed, do they want to?
        _mas_pm_drawn_art	Has the player drawn Monika before?
        _mas_pm_lang_other	Does the player speak a language besides English?
        _mas_pm_lang_jpn	Does the player speak Japanese?
        _mas_pm_eye_color	Not true/false. Eye color, blue/brown/green/hazel/grey/black or player-input. Can specify heterochromis.
        _mas_pm_hair_color	Not true/false. Hair color: brown/blonde/red/black or player input.
        _mas_pm_hair_length	Not true/false. Hair length: short/average/long
        _mas_pm_shaved_hair	If the player is bald, is their hair shaved or did they lose it?
        _mas_pm_no_hair_no_talk	Player has specified they are bald and don't want to talk about why.
        _mas_pm_skin_tone	Not true/false. Skin tone: light/tanned/dark
        _mas_pm_height	Not true/false. Player's height. Stored in centimeters. {Todo: get variables for what counts to Monika as tall or short?}
        _mas_pm_units_height_metric	Does the player measure their height with the metric system or feet/inches? True for metric.
        _mas_pm_shared_appearance	Player has shared their appearance with Monika.
        _mas_pm_would_like_mt_peak	Player would like to climb a mountain with Monika.
        _mas_pm_live_in_city	Does the player live in a city?
        _mas_pm_live_near_beach	Does the player live near a beach?
        _mas_pm_live_south_hemisphere	Does the player live in the Southern hemisphere? Affects seasons.
        _mas_pm_gets_snow	Does it snow where the player lives?
        _mas_pm_social_personality	Not true/false.
        _mas_pm_likes_panties	Is the player into panties?
        _mas_pm_no_talk_panties	Player has specified they don't want to talk about panty fetishes. Does not clarify if they like/dislike.
        _mas_pm_drinks_soda	Does the player drink soda?
        _mas_pm_eat_fast_food	Does the player eat fast food often?
        _mas_pm_wearsRing	Does the player wear a promise ring for Monika?
        _mas_pm_like_playing_sports	Does the player like to play sports?
        _mas_pm_like_playing_tennis	Does the player like to play tennis?
        _mas_pm_meditates	Does the player ever take time to meditate?
        _mas_pm_see_therapist	Does the player see a therapist?
        _mas_pm_watch_mangime	Does the player read manga/watch anime?
        _mas_pm_do_smoke	Does the player smoke?
        _mas_pm_do_smoke_quit	Is the player trying to quit smoking?
        _mas_pm_do_smoke_quit_succeeded_before	Has the player quit smoking successfully before?
        _mas_pm_driving_can_drive	Can the player drive a car?
        _mas_pm_driving_learning	If the player cannot drive, are they learning?
        _mas_pm_driving_been_in_accident	Has the player been in a car accident while driving?
        _mas_pm_driving_post_accident	If the player has been in an accident, do they still drive much?
        _mas_pm_donate_charity	Has the player donated to charity before?
        _mas_pm_volunteer_charity	Has the player volunteered for a charity before?
        _mas_pm_have_fam	Does the player have a family?
        _mas_pm_no_fam_bother	If the player does not have a family, does that bother them?
        _mas_pm_have_fam_mess	Is the player's family life messy/bad?
        _mas_pm_have_fam_mess_better	Not true/false. "YES"/"NO"/"MAYBE" if the player thinks things will get better with their family.
        _mas_pm_have_fam_sibs	Does the player have siblings?
        _mas_pm_no_talk_fam	The player has specified they do not want to talk about their family.
        _mas_pm_fam_like_monika	Does the player think their family would like Monika?
        _mas_pm_gone_to_prom	Did the player attend prom?
        _mas_pm_no_prom	Player has specified that their school did not have a prom.
        _mas_pm_prom_good	Did the player have a good time at prom?
        _mas_pm_had_prom_date	Did the player have a prom date?
        _mas_pm_prom_monika	Player has specified they would have had a better time at prom if Monika was there.
        _mas_pm_prom_not_interested	Player has specified they were not interested in prom.
        _mas_pm_prom_shy	If the player was not interested in prom, is it because they were too shy?
        _mas_pm_has_been_to_amusement_park	Has the player ever been to an amusement park?
        _mas_pm_likes_travelling	Does the player like to travel?
        _mas_pm_had_relationships_many	Has the player had multiple relationships before Monika?
        _mas_pm_had_relationships_just_one	Has the player had just one relationship before Monika?
        _mas_pm_read_yellow_wp	Has the player read the story The Yellow Wallpaper?
        _mas_pm_monika_evil	Does the player think Monika's actions were evil?
        _mas_pm_monika_evil_but_ok	Player has specified that even though her actions were evil, they forgive/love her.
        _mas_pm_is_bullying_victim	Has the player been bullied?
        _mas_pm_has_bullied_people	Has the player bullied others before?
        _mas_pm_currently_bullied	Is the player currently being bullied?
        _mas_pm_has_friends	Does the player have friends?
        _mas_pm_few_friends	Player has specified they only have a few friends.
        _mas_pm_feels_lonely_sometimes	Does the player sometimes feel lonely?
        _mas_pm_listened_to_grad_speech	Has the player heard Monika's graduate speech? This is set to False if they ignored it.
        _mas_grad_speech_timed_out	Set to true only if the player has ignored Monika's graduate speech twice.
        _mas_pm_liked_grad_speech	Did the player like Monika's graduation speech?
        _mas_pm_given_false_justice	Has the player been delivered false justice before?
        _mas_pm_monika_deletion_justice	Does the player think that Monika being deleted by so many people was justice?
        _mas_monika_deletion_justice_kidding	Monika believes player was teasing/joking when they said deleting her was justice.
        _mas_pm_would_come_to_spaceroom	Would the player take the chance to go to Monika's world? Set to None if they cannot answer.
        _mas_pm_owns_car	Does the player own a car?
        _mas_pm_owns_car_type	Not true/false. Type of vehicle player owns. For list of options, see monika_vehicle.
        _mas_pm_has_code_experience	Does the player have experience coding?
        _mas_pm_likes_poetry	Does the player like to read poetry?
        _mas_pm_likes_board_games	Does the player like board games?
        _mas_pm_works_out	Does the player work out much?
        _mas_pm_social_personality	Not true/false. Player's social personality. mas_SP_EXTROVERT/mas_SP_INTROVERT/mas_SP_AMBIVERT/mas_SP_UNSURE
        _mas_pm_likes_nature	Does the player like nature?
        _mas_pm_swear_frequency	Not true/false. Frequency of player's swearing: SF_OFTEN/SF_SOMETIMES/SF_NEVER
        _mas_gender == " "	"M" for male "F" for female and "X" for Gender Neutral

        _mas_bday_said_happybday
        _mas_f14_spent_f14
        _mas_nye_spent_nye
        _mas_player_bday_spent_time
        _mas_d25_spent_d25
        _mas_o31_tt_count
        sessions
        """

    其中, 除前六行外均为原版可调用的变量:

        mas_playername为str格式的玩家名称.

        mas_player_bday为list格式的玩家生日.

        mas_affection为int格式的好感度.

        mas_geolocation为str格式的玩家地理位置. 此条目应当尽可能简短到至多保留省名与城市名, 过长的条目会导致搜索引擎误解.

        mas_player_additions为list格式的补充数据. 此条目应当为一个list中的若干str, 且至多检索72项, 超出则mfocus每次随机抽取72项. 每项应当为一个简单表述, 过长的项可能会导致失焦.

        mas_sf_hcb为高可自定义性开关. 设为true后, MFocus将停止索引任何来自MAS存档的基本信息, 并能够同时检索至多360项补充数据.

            若启用hcb, 你应当格外注意使补充数据简短精炼, 有序性强, 否则会极大地降低MFocus命中率.

            启用hcb会缩减基本设定数据到最少, 以便用户提供针对性的补充.

    原理上, 任何条目都是可缺省的. 缺省关键变量将使其被默认值替代, 缺省事件变量将使其退出MFocus索引.

    原理上, 上传的存档json可以包含冗余的条目, 但其整体格式必须是完整可读的json.


- 附录2 MAICA标准触发器表格式:

    触发器的编写有以下规范:

        模板common_affection_template:

            {"template": "common_affection_template","name": "alter_affection"}

                其中name的值可以任取, 建议使用alter_affection.

                使用该模板的触发器会根据用户输入与上文内容, 决策对好感度应做的调整.

                若sf_extraction未启用, 此功能的准确性可能会受到一定程度的影响.

                好感度调幅默认为不超过+3.0, 你可以自行设定乘幅. 简单地对其调幅举例, 日常的问好大约会输出+0.2, 对美貌的称赞大约会输出+0.8, 简短的示爱大约会输出+1.5, 长段的示爱大约会输出+3.0.

                输出范例: {"code": "101", "status": "maica_mtrigger_trigger", "content": ["alter_affection", {"affection": "+1.5"}], "type": "carriage", "time_ms": 时间戳(毫秒)}

                该模板的触发器最多存在一个.

        模板common_switch_template:

            {"template": "common_switch_template","name": "change_clothes","exprop":{"item_name": {"zh": "衣服","en": "clothes"},"item_list": ["白色连衣裙", "黑色连衣裙"],"curr_item": "白色连衣裙", "suggestion": false}}

                其中name的值可以任取, 建议格式与范例尽可能一致且能表明用途.

                exprop的值是该模板的附加参数, 其中item_name的值为选择类目的性质(双语), item_list的值为所有可选条目的list, curr_item的值为当前已选条目. curr_item是可留空或缺省的.

                如果触发器匹配了请求, 但没有条目满足条件, 返回的选择将是false.

                若将suggestion设为true, 则若selection返回false将会额外返回suggestion, 其值为一个推荐参考条目.

                输出范例: {"code": "101", "status": "maica_mtrigger_trigger", "content": ["change_clothes", {"selection": "黑色连衣裙"}], "type": "carriage", "time_ms": 时间戳(毫秒)}

                该模板的触发器最多存在6个, 超出则随机抽取6个.

                每个该模板触发器的item_list中最多存在72项, 超出则随机抽取72项.

        模板common_meter_template:

            {"template": "common_meter_template","name": "change_distance","exprop":{"item_name": {"zh": "距离","en": "distance"},"value_limits": [0.0, 2.5],"curr_value": 0.67}}

                其中name的值可以任取, 建议格式与范例尽可能一致且能表明用途.

                exprop的值是该模板的附加参数, 其中item_name的值为选择类目的性质(双语), value_limits的两个项为数值可取的上下限, curr_value的值为当前值. curr_value是可留空或缺省的.

                如果触发器匹配了请求, 但范围内没有值满足条件, 返回的选择将是false.

                输出范例: {"code": "101", "status": "maica_mtrigger_trigger", "content": ["change_distance", {"value": "0.75"}], "type": "carriage", "time_ms": 时间戳(毫秒)}

                该模板的触发器最多存在6个, 超出则随机抽取6个.
        自由模板:

            {"template": "customized","name": "some_name","exprop":{"item_name": {"zh": "关闭游戏","en": "close game"}}}

                其中name的值可以任取, 建议格式与范例尽可能一致且能表明用途.

                exprop的值是该模板的附加参数, 其中item_name的值为该触发器的用途(双语)

                输出范例: {"code": "101", "status": "maica_mtrigger_trigger", "content": ["some_name"], "type": "carriage", "time_ms": 时间戳(毫秒)}

                该模板的触发器最多存在20个, 超出则随机抽取20个.

        对于未注明双语的条目, 可以任选中文或英文, 建议与用户语言保持一致.

            * 应当注意, 较新的OpenAI实例端点可能要求name的值仅包含字母, 数字, 横杠和下划线. 建议统一按照此规范编写.

    最终的触发器表为一包含触发器条目的list.